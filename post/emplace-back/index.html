<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.52" />
  <meta name="author" content="Gudmundur Einarsson">

  
  
  
  
    
      
    
  
  <meta name="description" content="tl;dr emplace_back is often mistaken as a faster push_back, while it is in fact just a different tool. Do not blindly replace push_back by emplace_back, be careful of how you use emplace_back, since it can have unexpected consequences.
I have repeatedly run into the choice of using emplace_back instead of push_back in C&#43;&#43;. This short blog post serves as my take on this decision.
Both of the methods in the title, along with insert and emplace, are ways to insert data into standard library containers.">

  
  <link rel="alternate" hreflang="en-us" href="https://gumeo.github.io/post/emplace-back/">

  


  

  
  
  <meta name="theme-color" content="hsl(339, 90%, 68%)">
  
  
  
  
    
  
  
    
    
      
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css">
      
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7cMerriweather%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-110075286-1', 'auto');
      
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  
  <link rel="alternate" href="https://gumeo.github.io/index.xml" type="application/rss+xml" title="Gudmundur Blog&amp;Bio">
  <link rel="feed" href="https://gumeo.github.io/index.xml" type="application/rss+xml" title="Gudmundur Blog&amp;Bio">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://gumeo.github.io/post/emplace-back/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@gumgumeo">
  <meta property="twitter:creator" content="@gumgumeo">
  
  <meta property="og:site_name" content="Gudmundur Blog&amp;Bio">
  <meta property="og:url" content="https://gumeo.github.io/post/emplace-back/">
  <meta property="og:title" content="emplace_back vs push_back | Gudmundur Blog&amp;Bio">
  <meta property="og:description" content="tl;dr emplace_back is often mistaken as a faster push_back, while it is in fact just a different tool. Do not blindly replace push_back by emplace_back, be careful of how you use emplace_back, since it can have unexpected consequences.
I have repeatedly run into the choice of using emplace_back instead of push_back in C&#43;&#43;. This short blog post serves as my take on this decision.
Both of the methods in the title, along with insert and emplace, are ways to insert data into standard library containers.">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2020-05-11T13:00:26&#43;02:00">
  
  <meta property="article:modified_time" content="2020-05-11T13:00:26&#43;02:00">
  

  
  

  <title>emplace_back vs push_back | Gudmundur Blog&amp;Bio</title>

</head>
<body id="top" data-spy="scroll" data-target="#toc" data-offset="71" class="dark">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">Gudmundur Blog&amp;Bio</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      
      <ul class="nav navbar-nav navbar-right">
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        
        
        
        
        
          
        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
            
          </a>
        </li>

        
        
      

      
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">emplace_back vs push_back</h1>

    

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2020-05-11 13:00:26 &#43;0200 CEST" itemprop="datePublished dateModified">
      May 11, 2020
    </time>
  </span>
  <span itemscope itemprop="author publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Gudmundur Einarsson">
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    5 min read
  </span>
  

  
  

  
  
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=emplace_back%20vs%20push_back&amp;url=https%3a%2f%2fgumeo.github.io%2fpost%2femplace-back%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fgumeo.github.io%2fpost%2femplace-back%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fgumeo.github.io%2fpost%2femplace-back%2f&amp;title=emplace_back%20vs%20push_back"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fgumeo.github.io%2fpost%2femplace-back%2f&amp;title=emplace_back%20vs%20push_back"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=emplace_back%20vs%20push_back&amp;body=https%3a%2f%2fgumeo.github.io%2fpost%2femplace-back%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      

<p>tl;dr <code>emplace_back</code> is often mistaken as a faster <code>push_back</code>, while it is in fact just a different tool. Do not blindly replace <code>push_back</code> by <code>emplace_back</code>, be careful of how you use <code>emplace_back</code>, since it can have unexpected consequences.</p>

<p>I have repeatedly run into the choice of using <code>emplace_back</code> instead of <code>push_back</code> in C++. This short blog post serves as my take on this decision.</p>

<p>Both of the methods in the title, along with <code>insert</code> and <code>emplace</code>, are ways to insert data into standard library containers. <code>emplace_back</code> is for adding a single element to the dynamic array <code>std::vector</code>. There is a somewhat subtle difference between the two:</p>

<ol>
<li><code>push_back</code> calls the constructor of the data that you intend to push and then pushes it to the container.</li>
<li><code>emplace_back</code> &ldquo;constructs in place&rdquo;, so one skips an extra move operation, potentially creating faster bytecode. This is done by forwarding the arguments to the container&rsquo;s template type constructor.</li>
</ol>

<p>On the surface, <code>emplace_back</code> might look like a faster <code>push_back</code>, but there is a subtle difference contained in the act of forwarding arguments. Searching for the problem online yields a lengthy discussion on the <a href="https://stackoverflow.com/questions/4303513/push-back-vs-emplace-back" target="_blank">issue (emplace_back vs push_back)</a>. In summary, the discussion leans towards choosing <code>emplace_back</code> to insert data into your container, however the reason is not completely clear.</p>

<h2 id="be-careful">Be careful</h2>

<p>After searching a bit more I found <a href="https://abseil.io/tips/112" target="_blank">this post</a>, which stresses how careful one should be with this decision. To further stress the ambiguity of the matter, the google c++ style guide does not provide an explicit preference. The reason the don&rsquo;t state a preference, is because these are simply slightly different tools, and you should not use <code>emplace_back</code> unless you properly understand it.</p>

<p>The following code should make it clear how <code>emplace_back</code> is different from <code>push_back</code>:</p>

<pre><code class="language-cpp">#include&lt;vector&gt;
#include&lt;iostream&gt;

int main(){
  // Basic example
  std::vector&lt;int&gt; foo;
  foo.push_back(10);
  foo.emplace_back(20);

  // More tricky example
  std::vector&lt;std::vector&lt;int&gt;&gt; foo_bar;
  //foo_bar.push_back(10); // Throws error!!!!
  foo_bar.emplace_back(20); // Compiles with no issue
  std::cout &lt;&lt; &quot;foo_bar size: &quot; &lt;&lt; foo_bar.size() &lt;&lt; &quot;\n&quot;;
  std::cout &lt;&lt; &quot;foo_bar[0] size: &quot; &lt;&lt; foo_bar[0].size() &lt;&lt; &quot;\n&quot;;
  return 0;
}
</code></pre>

<p>Uncommenting the line <code>foo_bar.push_back(10)</code> yields the following compilation error.</p>

<pre><code>$ g++ test.cpp -o test
test.cpp: In function â€˜int main()â€™:
test.cpp:11:24: error: no matching function for call to â€˜std::vector&lt;std::vector&lt;int&gt; &gt;::push_back(int)â€™
   foo_bar.push_back(10);
                        ^
... Some more verbose diagnostic
</code></pre>

<p>So we get an error. An extra diagnostic provides us with the following: <code>no known conversion for argument 1 from â€˜intâ€™ to â€˜const value_type&amp; {aka const std::vector&lt;int&gt;&amp;}â€™</code>. So it seems there is no conversion here that makes sense.</p>

<p>The compilation completes without errors if we comment out the trouble line. Running the code yields the following result:</p>

<pre><code>$ ./test
foo_bar size: 1
foo_bar[0] size: 20
</code></pre>

<p>What is the difference? For <code>emplace_back</code> we <strong>forward the arguments to the constructor</strong>, adding a new <code>std::vector&lt;int&gt; new_vector_to_add(20)</code> to <code>foo_bar</code>. This is the critical difference. So if you are using <code>emplace_back</code> you need to be a bit extra careful in double checking types.</p>

<h2 id="another-example-with-conversion">Another example with conversion</h2>

<p>The example above is very simple and shows the difference of forwarding arguments to the value type constructor or not. The following example I added in an <a href="https://stackoverflow.com/questions/61592849/no-narrowing-warnings-when-using-emplace-back-instead-of-push-back" target="_blank">SO question</a> shows a bit more subtle case where <code>emplace_back</code> could make us miss catching a narrowing conversion from <code>double</code> to <code>int</code>.</p>

<pre><code class="language-cpp">#include &lt;vector&gt;
class A {
 public:
  explicit A(int /*unused*/) {}
};
int main() {
  double foo = 4.5;
  std::vector&lt;A&gt; a_vec{};
  a_vec.emplace_back(foo); // No warning with Wconversion
  //A a(foo); // Gives compiler warning with Wconversion as expected
}
</code></pre>

<h2 id="why-is-this-a-problem">Why is this a problem?</h2>

<p>The problem is that we are unaware of the problem at compile-time. If this was not the intended behavior, we have caused a runtime error, which is generally harder to fix. Let us catch the issue somehow. You might wonder that some warning flags, e.g., <code>-Wall</code> could reveal the issue. However, the program compiles fine with <code>-Wall</code>. <code>-Wall</code> contains narrowing, but it does not contain conversion. Further, adding <code>-Wconversion</code> yields no warnings.</p>

<pre><code>$ g++ -Wall -Wconversion test_2.cpp -o test
</code></pre>

<p>The problem is that this conversion is happening in a system header, so we also need <code>-Wsystem-headers</code> to catch the issue.</p>

<pre><code>$ g++ -Wconversion -Wsystem-headers test_2.cpp 
In file included from /usr/include/c++/7/vector:60:0,
                 from test_2.cpp:1:
/usr/include/c++/7/bits/stl_algobase.h: In function â€˜constexpr int std::__lg(int)â€™:
/usr/include/c++/7/bits/stl_algobase.h:1001:44: warning: conversion to â€˜intâ€™ from â€˜long unsigned intâ€™ may alter its value [-Wconversion]
   { return sizeof(int) * __CHAR_BIT__  - 1 - __builtin_clz(__n); }
                                            ^
/usr/include/c++/7/bits/stl_algobase.h: In function â€˜constexpr unsigned int std::__lg(unsigned int)â€™:
/usr/include/c++/7/bits/stl_algobase.h:1005:44: warning: conversion to â€˜unsigned intâ€™ from â€˜long unsigned intâ€™ may alter its value [-Wconversion]
   { return sizeof(int) * __CHAR_BIT__  - 1 - __builtin_clz(__n); }
                                            ^
In file included from /usr/include/x86_64-linux-gnu/c++/7/bits/c++allocator.h:33:0,
                 from /usr/include/c++/7/bits/allocator.h:46,
                 from /usr/include/c++/7/vector:61,
                 from test_2.cpp:1:
/usr/include/c++/7/ext/new_allocator.h: In instantiation of â€˜void __gnu_cxx::new_allocator&lt;_Tp&gt;::construct(_Up*, _Args&amp;&amp; ...) [with _Up = A; _Args = {double&amp;}; _Tp = A]â€™:
/usr/include/c++/7/bits/alloc_traits.h:475:4:   required from â€˜static void std::allocator_traits&lt;std::allocator&lt;_Tp1&gt; &gt;::construct(std::allocator_traits&lt;std::allocator&lt;_Tp1&gt; &gt;::allocator_type&amp;, _Up*, _Args&amp;&amp; ...) [with _Up = A; _Args = {double&amp;}; _Tp = A; std::allocator_traits&lt;std::allocator&lt;_Tp1&gt; &gt;::allocator_type = std::allocator&lt;A&gt;]â€™
/usr/include/c++/7/bits/vector.tccðŸ’¯30:   required from â€˜void std::vector&lt;_Tp, _Alloc&gt;::emplace_back(_Args&amp;&amp; ...) [with _Args = {double&amp;}; _Tp = A; _Alloc = std::allocator&lt;A&gt;]â€™
test_2.cpp:9:25:   required from here
/usr/include/c++/7/ext/new_allocator.h:136:4: warning: conversion to â€˜intâ€™ from â€˜doubleâ€™ may alter its value [-Wfloat-conversion]
  { ::new((void *)__p) _Up(std::forward&lt;_Args&gt;(__args)...); }
</code></pre>

<p>And there you have it - look at all the verbose output. The problem is not apparent from this wall of text for the uninitiated.</p>

<h2 id="emplace-back-is-a-premature-optimization"><code>emplace_back</code> is a premature optimization.</h2>

<p>Going from <code>push_back</code> to <code>emplace_back</code> is a small change that can usually wait. If you want to use <code>emplace_back</code> from the start, then make sure you understand the differences. This is not just a faster <code>push_back</code>. For safety, reliability, and maintainability reasons, it is better to write the code with <code>push_back</code>. This choice reduces the chance of pushing an unwanted hard to find implicit conversion into the codebase, but you should weigh that risk against the potential speedups.</p>

    </div>

    





    
    

    

    


  </div>
</article>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2018 &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

